<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Inferencia Bayesiana - 7&nbsp; Estimación de Modelos Bayesianos (Parte 3)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./estimacion_modelos2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./estimacion_modelos3.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 3)</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Inferencia Bayesiana</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prefacio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pensamiento.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Pensamiento Bayesiano</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./unparametro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelos de un parámetro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./variosparametros.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelos de varios parámetros</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./computacion_bayes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Computación Bayesiana</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimacion_modelos1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 1)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimacion_modelos2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 2)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./estimacion_modelos3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 3)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#anova-de-una-vía" id="toc-anova-de-una-vía" class="nav-link active" data-scroll-target="#anova-de-una-vía"><span class="header-section-number">7.1</span> ANOVA de una vía</a>
  <ul class="collapse">
  <li><a href="#modelo-1" id="toc-modelo-1" class="nav-link" data-scroll-target="#modelo-1"><span class="header-section-number">7.1.1</span> Modelo 1</a></li>
  <li><a href="#modelo-2-previas-personalizadas" id="toc-modelo-2-previas-personalizadas" class="nav-link" data-scroll-target="#modelo-2-previas-personalizadas"><span class="header-section-number">7.1.2</span> Modelo 2: Previas personalizadas</a></li>
  <li><a href="#modelo-3" id="toc-modelo-3" class="nav-link" data-scroll-target="#modelo-3"><span class="header-section-number">7.1.3</span> Modelo 3</a></li>
  <li><a href="#comparando-grupos" id="toc-comparando-grupos" class="nav-link" data-scroll-target="#comparando-grupos"><span class="header-section-number">7.1.4</span> Comparando grupos</a></li>
  </ul></li>
  <li><a href="#anova-de-varias-vías" id="toc-anova-de-varias-vías" class="nav-link" data-scroll-target="#anova-de-varias-vías"><span class="header-section-number">7.2</span> ANOVA de varias vías</a>
  <ul class="collapse">
  <li><a href="#rendimiento-de-cultivo-según-el-método-de-labranza-y-fertilizante" id="toc-rendimiento-de-cultivo-según-el-método-de-labranza-y-fertilizante" class="nav-link" data-scroll-target="#rendimiento-de-cultivo-según-el-método-de-labranza-y-fertilizante"><span class="header-section-number">7.2.1</span> Rendimiento de Cultivo según el Método de Labranza y Fertilizante</a></li>
  <li><a href="#diseño-de-parcela-dividida" id="toc-diseño-de-parcela-dividida" class="nav-link" data-scroll-target="#diseño-de-parcela-dividida"><span class="header-section-number">7.2.2</span> Diseño de Parcela Dividida</a></li>
  <li><a href="#comparación-de-modelos" id="toc-comparación-de-modelos" class="nav-link" data-scroll-target="#comparación-de-modelos"><span class="header-section-number">7.2.3</span> Comparación de modelos</a></li>
  <li><a href="#medición-de-un-modelo-error-de-predicción" id="toc-medición-de-un-modelo-error-de-predicción" class="nav-link" data-scroll-target="#medición-de-un-modelo-error-de-predicción"><span class="header-section-number">7.2.4</span> Medición de un Modelo – Error de Predicción</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 3)</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="anova-de-una-vía" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="anova-de-una-vía"><span class="header-section-number">7.1</span> ANOVA de una vía</h2>
<p>La especie estudiada fue la mosca de la fruta, Drosophila melanogaster (Hanley &amp; Shapiro, 1994), conocida porque las hembras recién inseminadas no se aparean nuevamente durante al menos dos días y los machos no cortejan activamente a las hembras embarazadas. Para ilustrar el uso del modelo, se estudió la duración de la vida de los machos en función de su actividad sexual. En el experimento, se manipuló la actividad sexual suministrando a los machos individuales hembras vírgenes receptivas a una tasa de una u ocho vírgenes por día. La longevidad de estos machos se registró y se comparó con la de dos grupos de control: uno con machos mantenidos con hembras recién inseminadas en igual número que las hembras vírgenes y otro con machos sin hembras. El objetivo era determinar si la actividad sexual de los machos reducía su vida, ya que esto ya estaba establecido para las hembras. Un efecto perjudicial de la actividad sexual en machos sería sorprendente, dado que se presume que los costos fisiológicos de la actividad sexual son menores en machos que en hembras. Cada grupo experimental y de control constaba de 25 moscas macho.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_violin</span>(longevity <span class="sc">~</span> group, <span class="at">data =</span> FruitflyReduced) <span class="sc">%&gt;%</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height =</span> <span class="dv">0</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_point</span>(<span class="at">stat =</span> <span class="st">"summary"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fun =</span> mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="modelo-1" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="modelo-1"><span class="header-section-number">7.1.1</span> Modelo 1</h3>
<p>Es bastante fácil pedirle a <code>brm()</code> que ajuste un modelo para nosotros. Solo proporcionemos nuestras variables explicativas y de respuesta y veamos qué sucede.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>flies_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(longevity <span class="sc">~</span> group, <span class="at">data =</span> FruitflyReduced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>flies_stan <span class="ot">&lt;-</span> <span class="fu">stanfit</span>(flies_brm)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>flies_stan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                    mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
b_Intercept        63.52    0.06 2.93   57.66   61.55   63.55   65.44   69.26  2555    1
b_groupPregnant1    1.29    0.08 4.16   -6.93   -1.49    1.35    4.17    9.29  2816    1
b_groupPregnant8   -0.09    0.08 4.19   -8.39   -2.84   -0.10    2.66    8.24  2882    1
b_groupVirgin1     -6.71    0.08 4.14  -14.91   -9.45   -6.70   -3.94    1.25  2797    1
b_groupVirgin8    -24.78    0.07 4.17  -32.98  -27.45  -24.77  -21.97  -16.70  3131    1
sigma              14.88    0.02 0.96   13.16   14.21   14.85   15.50   16.88  3274    1
Intercept          57.46    0.02 1.30   54.94   56.61   57.45   58.34   60.00  4535    1
lprior             -7.49    0.00 0.05   -7.60   -7.52   -7.49   -7.46   -7.40  3197    1
lp__             -519.50    0.04 1.73 -523.79 -520.38 -519.17 -518.21 -517.12  1922    1

Samples were drawn using NUTS(diag_e) at Sat Jun 22 22:02:05 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_combo</span>(<span class="fu">as.mcmc.list</span>(flies_stan))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas_ridges</span>(<span class="fu">as.mcmc.list</span>(flies_stan), <span class="at">regex_pars =</span> <span class="st">"b_g"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Analicemos la codificación que usa STAN en la variable categórica:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">standata</span>(flies_brm) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(head)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$N
[1] 125

$Y
[1] 35 37 49 46 63 39

$K
[1] 5

$Kc
[1] 4

$X
  Intercept groupPregnant1 groupPregnant8 groupVirgin1 groupVirgin8
1         1              0              1            0            0
2         1              0              1            0            0
3         1              0              1            0            0
4         1              0              1            0            0
5         1              0              1            0            0
6         1              0              1            0            0

$prior_only
[1] 0</code></pre>
</div>
</div>
<p>El modelo resulta ser en este caso:</p>
<p>[ = _0 + _1 x_1 + _2 x_2 + _3 x_3 + _4 x_4 + \ = _0 + _1 x_1 + _2 x_2 + _3 x_3 + _4 x_4 + {Norm}(0, ) ]</p>
<p>donde, por ejemplo,</p>
<p>[ x_1 = [![ = ]!] \ =</p>
<span class="math display">\[\begin{cases}
          1 &amp; \mbox{si group}   =  \mbox{Pregnant1} \\
          0 &amp; \mbox{si group} \neq \mbox{Pregnant1}
       \end{cases}\]</span>
<p>]</p>
<p>En otras palabras, la distribución de la longevidad es</p>
<ul>
<li><span class="math inline">\({\sf Norm}(\beta_0, \sigma)\)</span> para el grupo <code>None0</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_0 + \beta_1, \sigma)\)</span> para el grupo <code>Pregnant1</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_0 + \beta_2, \sigma)\)</span> para el grupo <code>Pregnant2</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_0 + \beta_3, \sigma)\)</span> para el grupo <code>Virgin1</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_0 + \beta_4, \sigma)\)</span> para el grupo <code>Virgin2</code></li>
</ul>
<p>Aquí están las distribuciones previas predeterminadas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(flies_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class           coef group resp dpar nlpar lb ub       source
                 (flat)         b                                                 default
                 (flat)         b groupPregnant1                             (vectorized)
                 (flat)         b groupPregnant8                             (vectorized)
                 (flat)         b   groupVirgin1                             (vectorized)
                 (flat)         b   groupVirgin8                             (vectorized)
 student_t(3, 58, 17.8) Intercept                                                 default
  student_t(3, 0, 17.8)     sigma                                       0         default</code></pre>
</div>
</div>
<ul>
<li><p>Previas planas e impropias para los parámetros <code>b_</code>.</p></li>
<li><p>Distribución t con 3 grados de libertad para el intercepto (colas más pesadas que una distribución normal).</p>
<ul>
<li>Nota: Esto es realmente una previa para <span class="math inline">\(\alpha_0\)</span> (efecto medio de toda la población), no <span class="math inline">\(\beta_0\)</span>, ya que usualmente es más fácil especificar una previa para <span class="math inline">\(\alpha_0\)</span>. Si por alguna razón quisiéramos especificar una previa para <span class="math inline">\(\beta_0\)</span> en su lugar, hay un pequeño truco: usar la fórmula <code>longevity ~ 0 + intercept + group</code>.</li>
<li>Si tienes curiosidad sobre de dónde vienen los valores 58 y 18, aquí hay una buena suposición:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">df_stats</span>(<span class="sc">~</span> longevity, <span class="at">data =</span> FruitflyReduced, mean, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   response  mean       sd
1 longevity 57.44 17.56389</code></pre>
</div>
</div></li>
<li><p>“T” para <code>sigma</code>.</p></li>
</ul>
</section>
<section id="modelo-2-previas-personalizadas" class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="modelo-2-previas-personalizadas"><span class="header-section-number">7.1.2</span> Modelo 2: Previas personalizadas</h3>
<p>El modelo anterior difiere del modelo básico en el Kruschke.</p>
<p>Podemos acercarnos más al modelo de <em>DBDA</em> usando esto:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>flies2_brm <span class="ot">&lt;-</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(longevity <span class="sc">~</span> group, <span class="at">data =</span> FruitflyReduced,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_prior</span>(<span class="at">class =</span> <span class="st">"Intercept"</span>, <span class="st">"normal(60, 100)"</span>),  <span class="co"># 100 = 5 * 20</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_prior</span>(<span class="at">class =</span> <span class="st">"b"</span>, <span class="st">"normal(0, 10)"</span>),  <span class="co"># group = "b" es el valor predeterminado; se podría omitir</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_prior</span>(<span class="at">class =</span> <span class="st">"sigma"</span>, <span class="st">"uniform(20.0/1000.0, 20.0 * 1000.0)"</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: It appears as if you have specified an upper bounded prior on a parameter that has no natural upper bound.
If this is really what you want, please specify argument 'ub' of 'set_prior' appropriately.
Warning occurred for prior 
&lt;lower=0&gt; sigma ~ uniform(20.0/1000.0, 20.0 * 1000.0)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(flies2_brm)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stancode</span>(flies2_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esto todavía no es exactamente igual al modelo utilizado por Kruschke. Resulta que hay múltiples maneras de codificar los <span class="math inline">\(\beta\)</span>s. Un tercero es utilizado por Kruschke y requiere un poco más de trabajo para ajustarse usando <code>brm()</code>:</p>
</section>
<section id="modelo-3" class="level3" data-number="7.1.3">
<h3 data-number="7.1.3" class="anchored" data-anchor-id="modelo-3"><span class="header-section-number">7.1.3</span> Modelo 3</h3>
<p>Si eliminamos el intercepto en el modelo <code>brm()</code>, obtenemos un modelo con un <span class="math inline">\(\beta_i\)</span> para cada media de grupo en lugar de un <span class="math inline">\(\beta_0\)</span> para el primer grupo y un <span class="math inline">\(\beta_i\)</span> para la diferencia en las medias de los grupos cuando <span class="math inline">\(i &gt; 0\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>flies3_brm <span class="ot">&lt;-</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    longevity <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> group, <span class="at">data =</span> FruitflyReduced,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_prior</span>(<span class="at">class =</span> <span class="st">"b"</span>, <span class="st">"normal(60, 10)"</span>),  <span class="co"># group = "b" es el valor predeterminado; se podría omitir</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_prior</span>(<span class="at">class =</span> <span class="st">"sigma"</span>, <span class="st">"uniform(20.0/1000.0, 20.0 * 1000.0)"</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_prior =</span> <span class="cn">TRUE</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: It appears as if you have specified an upper bounded prior on a parameter that has no natural upper bound.
If this is really what you want, please specify argument 'ub' of 'set_prior' appropriately.
Warning occurred for prior 
&lt;lower=0&gt; sigma ~ uniform(20.0/1000.0, 20.0 * 1000.0)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(flies3_brm)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stancode</span>(flies3_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esto es equivalente a</p>
<p>[ = _0 x_0 + _1 x_1 + _2 x_2 + _3 x_3 + _4 x_4 + = _0 x_0 + _1 x_1 + _2 x_2 + _3 x_3 + _4 x_4 + {Norm}(0, ) ]</p>
<p>donde, por ejemplo,</p>
<p>[ x_1 = [![ = ]!] \ =</p>
<span class="math display">\[\begin{cases}
          1 &amp; \mbox{si group}   =  \mbox{Pregnant1} \\
          0 &amp; \mbox{si group} \neq \mbox{Pregnant1}
       \end{cases}\]</span>
<p>]</p>
<p>En otras palabras, la distribución de la longevidad es</p>
<ul>
<li><span class="math inline">\({\sf Norm}(\beta_0, \sigma)\)</span> para el grupo <code>None0</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_1, \sigma)\)</span> para el grupo <code>Pregnant1</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_2, \sigma)\)</span> para el grupo <code>Pregnant2</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_3, \sigma)\)</span> para el grupo <code>Virgin1</code></li>
<li><span class="math inline">\({\sf Norm}(\beta_4, \sigma)\)</span> para el grupo <code>Virgin2</code></li>
</ul>
</section>
<section id="comparando-grupos" class="level3" data-number="7.1.4">
<h3 data-number="7.1.4" class="anchored" data-anchor-id="comparando-grupos"><span class="header-section-number">7.1.4</span> Comparando grupos</h3>
<section id="comparación-con-el-grupo-de-referencia" class="level4" data-number="7.1.4.1">
<h4 data-number="7.1.4.1" class="anchored" data-anchor-id="comparación-con-el-grupo-de-referencia"><span class="header-section-number">7.1.4.1</span> Comparación con el “grupo de referencia”</h4>
<p>Usamos el modelo 2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stanfit</span>(flies2_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                    mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
b_Intercept        61.72    0.05 2.48   56.91   60.07   61.71   63.41   66.62  3027    1
b_groupPregnant1    2.81    0.06 3.68   -4.21    0.25    2.74    5.25   10.19  3874    1
b_groupPregnant8    1.50    0.06 3.63   -5.79   -0.87    1.53    3.94    8.48  4068    1
b_groupVirgin1     -4.53    0.06 3.66  -11.85   -6.98   -4.49   -2.17    2.71  3667    1
b_groupVirgin8    -21.11    0.06 3.61  -28.17  -23.58  -21.16  -18.67  -14.01  3874    1
sigma              14.97    0.02 0.98   13.23   14.29   14.91   15.58   17.06  4221    1
Intercept          57.45    0.02 1.32   54.86   56.54   57.49   58.37   60.00  4806    1
lprior            -30.96    0.01 0.81  -32.80  -31.46  -30.88  -30.38  -29.62  3555    1
lp__             -543.16    0.04 1.74 -547.45 -544.09 -542.79 -541.89 -540.81  1974    1

Samples were drawn using NUTS(diag_e) at Sat Jun 22 22:04:26 2024.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>En este modelo, un grupo corresponde al intercepto del modelo, y las comparaciones de otros grupos con este grupo implican investigar la distribución posterior de uno de los otros <span class="math inline">\(\beta\)</span>s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>flies_post <span class="ot">&lt;-</span> <span class="fu">posterior</span>(flies_stan)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(flies_post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_Intercept"      "b_groupPregnant1" "b_groupPregnant8" "b_groupVirgin1"   "b_groupVirgin8"  
 [6] "sigma"            "Intercept"        "lprior"           "lp__"             "chain"           
[11] "iter"            </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_post</span>(flies_post<span class="sc">$</span>b_groupPregnant1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$posterior
      ESS     mean   median     mode
var1 2880 1.288035 1.346441 1.688973

$hdi
  prob        lo       hi
1 0.95 -6.686603 9.430803</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hdi</span>(flies_post<span class="sc">$</span>b_groupPregnant1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   par        lo       hi      mode prob
1 var1 -6.686603 9.430803 0.9314014 0.95</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_post</span>(flies_post<span class="sc">$</span>b_groupVirgin1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$posterior
          ESS      mean   median      mode
var1 2964.378 -6.714818 -6.70026 -5.776553

$hdi
  prob        lo       hi
1 0.95 -14.83658 1.274635</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(<span class="fu">as.mcmc.list</span>(flies_stan), <span class="at">pars =</span> <span class="st">"b_groupVirgin1"</span>, <span class="at">prob =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-12-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hdi</span>(flies_post<span class="sc">$</span>b_groupVirgin1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   par        lo       hi      mode prob
1 var1 -14.83658 1.274635 -4.381462 0.95</code></pre>
</div>
</div>
</section>
<section id="comparación-de-otros-pares-de-grupos" class="level4" data-number="7.1.4.2">
<h4 data-number="7.1.4.2" class="anchored" data-anchor-id="comparación-de-otros-pares-de-grupos"><span class="header-section-number">7.1.4.2</span> Comparación de otros pares de grupos</h4>
<p>¿Qué pasa si queremos comparar los grupos <code>Virgin1</code> y <code>Virgin8</code>? Podemos usar la identidad <span class="math inline">\(\beta_0 + \beta_i - (\beta_0 + \beta_j) = \beta_i - \beta_j\)</span> para simplificar el álgebra y hacerlo de esta manera.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>flies_post <span class="ot">&lt;-</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  flies_post <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dVirgin =</span> b_groupVirgin8 <span class="sc">-</span> b_groupVirgin1)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_post</span>(flies_post<span class="sc">$</span>dVirgin, <span class="at">xlab =</span> <span class="st">"Virgin8 - Virgin1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$posterior
          ESS     mean    median      mode
var1 5166.695 -18.0649 -18.04029 -19.36771

$hdi
  prob       lo       hi
1 0.95 -26.6462 -9.91304</code></pre>
</div>
</div>
</section>
<section id="contrastes-comparación-de-grupos-de-grupos" class="level4" data-number="7.1.4.3">
<h4 data-number="7.1.4.3" class="anchored" data-anchor-id="contrastes-comparación-de-grupos-de-grupos"><span class="header-section-number">7.1.4.3</span> Contrastes: Comparación de “grupos de grupos”</h4>
<p>¿Qué pasa si queremos comparar los dos grupos de vírgenes con los otros 3 grupos? Esto es un poco más fácil de hacer usando el modelo sin un término de intercepto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>flies3_post <span class="ot">&lt;-</span> <span class="fu">posterior</span>(flies3_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Method 'posterior_samples' is deprecated. Please see ?as_draws for recommended
alternatives.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(flies3_post)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "b_groupNone0"     "b_groupPregnant1" "b_groupPregnant8" "b_groupVirgin1"   "b_groupVirgin8"  
 [6] "sigma"            "prior_b"          "prior_sigma"      "lprior"           "lp__"            </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>flies3_post <span class="ot">&lt;-</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  flies3_post <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">contrast =</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>      (b_groupVirgin8 <span class="sc">+</span> b_groupVirgin1)<span class="sc">/</span><span class="dv">2</span> <span class="sc">-</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>      (b_groupPregnant1 <span class="sc">+</span> b_groupPregnant8 <span class="sc">+</span> b_groupNone0) <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_post</span>(flies3_post<span class="sc">$</span>contrast, <span class="at">xlab =</span> <span class="st">"Virgin vs non-virgin groups"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$posterior
         ESS      mean    median      mode
var1 5070.07 -14.79242 -14.81572 -14.41102

$hdi
  prob        lo        hi
1 0.95 -19.99495 -9.614157</code></pre>
</div>
</div>
<p>La expresión</p>
<p>[ - = - _0 - _1 - _2 + _3 + _4 ]</p>
<p>es un ejemplo de un <strong>contraste</strong>. Un contraste es simplemente una combinación lineal de las medias de los grupos tal que la suma de los coeficientes sea 0. Muchas relaciones interesantes pueden investigarse usando contrastes, y el paquete brms incluye la función <code>hypothesis()</code> para ayudarnos a hacer esto. (Nota: debido a que incluimos <code>sample_prior = TRUE</code> en la llamada a <code>brm()</code> para este modelo, el gráfico a continuación muestra tanto las distribuciones previas como las posteriores para el contraste.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hypothesis</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    flies3_brm,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(groupVirgin8 + groupVirgin1) / 2 &lt; </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">      (groupPregnant1 + groupPregnant8 + groupNone0) / 3"</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>h</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
                Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1 ((groupVirgin8+gr... &lt; 0   -14.79      2.67   -19.07   -10.39        Inf         1    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="múltiples-hipótesis-a-la-vez" class="level4" data-number="7.1.4.4">
<h4 data-number="7.1.4.4" class="anchored" data-anchor-id="múltiples-hipótesis-a-la-vez"><span class="header-section-number">7.1.4.4</span> Múltiples hipótesis a la vez</h4>
<p>Incluso podemos probar múltiples hipótesis a la vez.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>h2 <span class="ot">&lt;-</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hypothesis</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    flies3_brm,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"groupVirgin1 &lt; (groupPregnant1 + groupPregnant8 + groupNone0) / 3"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"groupVirgin8 &lt; (groupPregnant1 + groupPregnant8 + groupNone0) / 3"</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>h2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
                Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1 (groupVirgin1)-((... &lt; 0    -6.52      3.32   -11.93    -0.92      35.36      0.97    *
2 (groupVirgin8)-((... &lt; 0   -23.06      3.34   -28.61   -17.51        Inf      1.00    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(h2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="igualdad-o-desigualdad" class="level4" data-number="7.1.4.5">
<h4 data-number="7.1.4.5" class="anchored" data-anchor-id="igualdad-o-desigualdad"><span class="header-section-number">7.1.4.5</span> ¿Igualdad o desigualdad?</h4>
<p>En el ejemplo anterior, expresamos nuestro contraste como una desigualdad. También podemos expresarlo como una igualdad. El resultado que obtenemos de <code>hypothesis()</code> es un poco diferente si lo hacemos así.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>h3 <span class="ot">&lt;-</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hypothesis</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    flies3_brm,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"groupVirgin1 = (groupPregnant1 + groupPregnant8 + groupNone0) / 3"</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"groupVirgin8 = (groupPregnant1 + groupPregnant8 + groupNone0) / 3"</span>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>h3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hypothesis Tests for class b:
                Hypothesis Estimate Est.Error CI.Lower CI.Upper Evid.Ratio Post.Prob Star
1 (groupVirgin1)-((... = 0    -6.52      3.32   -12.90     0.18        0.6      0.38     
2 (groupVirgin8)-((... = 0   -23.06      3.34   -29.68   -16.39        0.0      0.00    *
---
'CI': 90%-CI for one-sided and 95%-CI for two-sided hypotheses.
'*': For one-sided hypotheses, the posterior probability exceeds 95%;
for two-sided hypotheses, the value tested against lies outside the 95%-CI.
Posterior probabilities of point hypotheses assume equal prior probabilities.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(h3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>El IC es bidireccional en lugar de unidireccional.</li>
<li>La Ratio de Evidencia se define de manera diferente.
<ul>
<li>Para las desigualdades, esta es la razón de las probabilidades posteriores de que la desigualdad sea verdadera vs.&nbsp;falsa.</li>
<li>Para las igualdades, esta es la razón de la densidad posterior (de la igualdad sostenida) a la densidad previa (Factor de Bayes). (Esto solo funciona si <code>sample_prior = TRUE</code>, ya que se requieren muestras previas para hacer el cálculo.)</li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="anova-de-varias-vías" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="anova-de-varias-vías"><span class="header-section-number">7.2</span> ANOVA de varias vías</h2>
<section id="rendimiento-de-cultivo-según-el-método-de-labranza-y-fertilizante" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="rendimiento-de-cultivo-según-el-método-de-labranza-y-fertilizante"><span class="header-section-number">7.2.1</span> Rendimiento de Cultivo según el Método de Labranza y Fertilizante</h3>
<p>Los datos en <code>CalvinBayes::SplitPlotAgri</code> provienen de un estudio agrícola en el que se utilizaron diferentes métodos de labranza y diferentes fertilizantes, y posteriormente se midió el rendimiento del cultivo (en bushels por acre).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(Yield <span class="sc">~</span> Fert <span class="sc">|</span> <span class="er">~</span> Till, <span class="at">data =</span> SplitPlotAgri, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ajustamos dos modelos: sin/con interacción entre fertilizante y labranza. Estamos interesados en la pregunta: ¿Cómo usarías cada modelo para estimar el rendimiento medio al usar labranza de contorno (ridge) y fertilizante profundo (deep)?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fert1_brm <span class="ot">&lt;-</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(Yield <span class="sc">~</span> Till <span class="sc">+</span> Fert, <span class="at">data =</span> SplitPlotAgri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fert2_brm <span class="ot">&lt;-</span>     </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(Yield <span class="sc">~</span> Till <span class="sc">*</span> Fert, <span class="at">data =</span> SplitPlotAgri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fert1_brm  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Yield ~ Till + Fert 
   Data: SplitPlotAgri (Number of observations: 99) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     120.41      2.87   114.86   126.19 1.00     4357     2743
TillMoldbrd    16.08      3.27     9.70    22.42 1.00     3896     2453
TillRidge      15.71      3.12     9.57    21.80 1.00     4271     3005
FertDeep       15.76      3.25     9.41    22.10 1.00     4134     3133
FertSurface    12.59      3.25     6.15    18.94 1.00     4480     3303

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma    13.12      0.95    11.44    15.13 1.00     3745     2849

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Nota que este modelo implica que la diferencia en rendimiento entre el uso de dos fertilizantes es la misma para cada uno de los tres métodos de labranza y la diferencia debida a los métodos de labranza es la misma para cada uno de los tres fertilizantes. Esto puede no ser una suposición razonable. Tal vez algunos fertilizantes funcionen mejor con ciertos métodos de labranza que con otros. El modelo 2 permite esto.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fert2_brm  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Yield ~ Till * Fert 
   Data: SplitPlotAgri (Number of observations: 99) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept                 124.23      3.72   117.04   131.45 1.00     1898     2074
TillMoldbrd                16.57      5.35     6.03    26.76 1.00     1985     2560
TillRidge                   3.73      5.38    -6.42    14.27 1.00     1900     2557
FertDeep                    9.55      5.27    -0.60    20.11 1.00     2027     2602
FertSurface                 7.14      5.15    -2.84    17.11 1.00     1974     2835
TillMoldbrd:FertDeep        0.63      7.67   -14.34    15.87 1.00     2173     2826
TillRidge:FertDeep         18.04      7.57     2.94    32.74 1.00     2055     2734
TillMoldbrd:FertSurface    -1.98      7.62   -16.70    13.11 1.00     2057     2670
TillRidge:FertSurface      18.10      7.40     3.56    32.76 1.00     2131     2520

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma    12.70      0.95    11.01    14.73 1.00     4091     2968

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Como antes, podemos optar por ajustar el modelo sin una intersección. Esto produce una diferente parametrización del mismo modelo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fert2a_brm <span class="ot">&lt;-</span>   </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(Yield <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Till <span class="sc">*</span> Fert, <span class="at">data =</span> SplitPlotAgri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fert2a_brm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Yield ~ 0 + Till * Fert 
   Data: SplitPlotAgri (Number of observations: 99) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
TillChisel                124.36      3.79   117.14   132.00 1.00     1686     2259
TillMoldbrd               140.85      3.99   133.13   148.72 1.00     3371     2580
TillRidge                 128.03      3.83   120.74   135.56 1.00     3107     2710
FertDeep                    9.39      5.22    -0.82    19.43 1.00     1546     2872
FertSurface                 6.97      5.33    -3.65    17.45 1.00     1606     2377
TillMoldbrd:FertDeep        0.78      7.86   -14.53    16.44 1.00     2013     2594
TillRidge:FertDeep         17.99      7.61     2.82    33.26 1.00     1718     2658
TillMoldbrd:FertSurface    -1.82      7.81   -17.10    13.32 1.00     1866     2352
TillRidge:FertSurface      18.14      7.72     3.32    33.43 1.00     1544     2225

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma    12.70      0.97    11.02    14.75 1.00     3415     2432

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
</section>
<section id="diseño-de-parcela-dividida" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="diseño-de-parcela-dividida"><span class="header-section-number">7.2.2</span> Diseño de Parcela Dividida</h3>
<p>El estudio utilizó 33 campos diferentes. Cada campo se dividió en 3 secciones y se aplicó un fertilizante diferente a cada una de las tres secciones. (Qué fertilizante se utilizó en qué sección se determinó al azar). Esto se llama un “diseño de parcela dividida” (incluso si se aplica a cosas que no son campos de cultivo).</p>
<p>Hubiera sido posible dividir cada campo en 9 subparcelas y usar todas las combinaciones de labranza y fertilizante, pero ese no fue el enfoque de este estudio. El método de labranza fue el mismo para todo el campo, probablemente porque era mucho más eficiente arar los campos de esta manera.</p>
<p>El gráfico a continuación indica que diferentes campos parecen tener rendimientos base diferentes, ya que los puntos asociados con un campo tienden a estar cerca de la parte superior o inferior de cada uno de los grupos de fertilizantes. Podemos agregar una variable adicional a nuestro modelo para manejar esta situación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(Yield <span class="sc">~</span> Fert <span class="sc">|</span> <span class="er">~</span> Till, <span class="at">data =</span> SplitPlotAgri, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_line</span>(<span class="at">group =</span> <span class="sc">~</span>Field)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="estimacion_modelos3_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fert3_brm <span class="ot">&lt;-</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># el uso de factor() es importante aquí porque los ids de campo son números</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># factor convierte esto en un factor (es decir, una variable nominal)</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(Yield <span class="sc">~</span> Till <span class="sc">*</span> Fert <span class="sc">+</span> <span class="fu">factor</span>(Field), <span class="at">data =</span> SplitPlotAgri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 3994 transitions after warmup that exceeded the maximum treedepth. Increase max_treedepth above 10. See
https://mc-stan.org/misc/warnings.html#maximum-treedepth-exceeded</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The largest R-hat is 3.09, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>fert3_brm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Parts of the model have not converged (some Rhats are &gt; 1.05). Be careful when analysing
the results! We recommend running more iterations and/or setting stronger priors.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Yield ~ Till * Fert + factor(Field) 
   Data: SplitPlotAgri (Number of observations: 99) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                        Estimate Est.Error  l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept                 118.62      3.64    111.42   125.64 1.16       21       52
TillMoldbrd             -3993.97   5617.77 -15275.81  5024.52 2.83        5       15
TillRidge                 846.24   7487.03  -8079.22 15129.64 3.09        5       12
FertDeep                   10.06      2.22      5.75    14.91 1.07       46       76
FertSurface                 7.93      2.26      3.94    12.75 1.13       23       35
factorField2               14.92      5.09      5.20    25.84 1.11       30       74
factorField3               17.76      5.32      7.21    27.91 1.15       21       36
factorField4                5.64      5.03     -3.70    15.59 1.12       25       64
factorField5               15.61      5.04      5.39    25.26 1.09       36       84
factorField6               -1.20      5.21    -11.49    10.17 1.11       34       56
factorField7               -7.90      4.85    -17.36     2.00 1.12       31       77
factorField8              -10.61      4.78    -19.83    -1.17 1.10       32       88
factorField9               -0.39      4.90     -9.76    10.20 1.14       23       39
factorField10              17.20      4.93      7.23    27.42 1.10       34       49
factorField11              14.69      4.56      6.03    24.60 1.08       40       51
factorField12              -1.96      4.63    -10.90     7.66 1.09       40       51
factorField13            4020.43   5617.52  -5001.67 15300.17 2.83        5       15
factorField14            4025.06   5617.54  -4991.98 15311.47 2.83        5       15
factorField15            4006.35   5617.56  -5005.94 15289.72 2.83        5       15
factorField16            4037.82   5617.58  -4979.57 15321.00 2.83        5       15
factorField17            4013.62   5617.56  -5004.07 15299.69 2.83        5       15
factorField18            4006.04   5617.58  -5010.49 15289.48 2.83        5       15
factorField19            4015.75   5617.69  -4996.78 15300.58 2.83        5       15
factorField20            4024.04   5617.54  -4992.59 15306.36 2.83        5       15
factorField21            4002.01   5617.56  -5018.61 15292.34 2.83        5       15
factorField22            4012.03   5617.58  -5003.78 15300.71 2.83        5       15
factorField23            -847.07   7485.88 -15127.18  8082.54 3.09        5       12
factorField24            -814.03   7485.82 -15097.40  8107.76 3.09        5       12
factorField25            -845.72   7485.88 -15126.80  8080.23 3.09        5       12
factorField26            -853.68   7485.90 -15134.72  8071.49 3.09        5       12
factorField27            -836.49   7485.92 -15117.38  8088.86 3.09        5       12
factorField28            -837.29   7485.89 -15120.52  8088.57 3.09        5       12
factorField29            -849.05   7485.87 -15131.84  8074.98 3.09        5       12
factorField30            -846.03   7486.02 -15127.26  8077.18 3.09        5       12
factorField31            -819.32   7485.91 -15101.48  8110.30 3.09        5       12
factorField32            -835.36   7485.78 -15114.69  8093.58 3.09        5       12
factorField33            -817.37   7485.90 -15103.69  8110.13 3.09        5       12
TillMoldbrd:FertDeep        0.18      3.21     -6.92     5.71 1.06       52      121
TillRidge:FertDeep         17.02      3.10     10.90    23.02 1.06       50      149
TillMoldbrd:FertSurface    -2.83      3.27     -9.40     3.70 1.07       52       59
TillRidge:FertSurface      16.86      3.51      9.02    23.05 1.16       20       38

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     5.77      0.54     4.79     6.87 1.03       65      145

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Afortunadamente, en realidad no queremos este modelo. Ahora tenemos un ajuste para cada campo, y hubo 33 campos. Pero realmente no estamos interesados en predecir el rendimiento <em>para un campo dado</em>. Nuestro interés principal es en qué fertilizantes y métodos de labranza funcionan bien.</p>
<p>Si pensamos que la calidad del campo podría describirse mediante una distribución normal (u otra distribución), podríamos estar más interesados en los parámetros de esa distribución que en las estimaciones específicas para los campos particulares en este estudio. El tipo de modelo que queremos para esto se llama un modelo <strong>jerárquico</strong> o <strong>multinivel</strong>, y <code>brm()</code> facilita la descripción de dicho modelo.</p>
<p>Aquí hay una manera de pensar sobre tal modelo</p>
<ul>
<li>Cada campo tiene una productividad base.</li>
<li>Las productividades base son normales con alguna media y desviación estándar que nos dicen sobre la distribución de la productividad entre campos. Nuestros 33 campos deberían ayudarnos a estimar esta distribución.</li>
<li>Esa productividad base puede ajustarse hacia arriba o hacia abajo dependiendo del método de labranza y fertilizante utilizado.</li>
</ul>
<p>En la jerga de <code>brm()</code>, el efecto del campo es ajustar la intersección, así que podemos escribirlo así:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>fert4_brm <span class="ot">&lt;-</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(Yield <span class="sc">~</span> Till <span class="sc">*</span> Fert <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Field), <span class="at">data =</span> SplitPlotAgri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<p>Podemos ver en la salida a continuación que la variabilidad de parcela a parcela se estima con una desviación estándar de aproximadamente 8 a 15. Las estimaciones individuales de los campos están ocultas en este informe, pero puedes verlas si escribes <code>stanfit(fert_brm)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>fert4_brm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Yield ~ Till * Fert + (1 | Field) 
   Data: SplitPlotAgri (Number of observations: 99) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~Field (Number of levels: 33) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)    11.56      1.66     8.80    15.32 1.01      635     1168

Regression Coefficients:
                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept                 124.12      3.65   117.18   131.36 1.01      629     1356
TillMoldbrd                16.72      5.41     6.03    26.96 1.00      721     1379
TillRidge                   3.91      5.47    -6.98    14.40 1.01      602     1195
FertDeep                    9.48      2.32     4.84    14.00 1.00     1752     1972
FertSurface                 7.13      2.35     2.44    11.71 1.00     1978     2308
TillMoldbrd:FertDeep        0.76      3.47    -6.04     7.65 1.00     2009     2683
TillRidge:FertDeep         17.99      3.27    11.64    24.62 1.00     1986     2424
TillMoldbrd:FertSurface    -1.87      3.48    -8.79     5.12 1.00     2138     2550
TillRidge:FertSurface      18.03      3.38    11.48    24.79 1.00     2088     2590

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     5.71      0.53     4.76     6.82 1.00     1669     2644

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
</section>
<section id="comparación-de-modelos" class="level3" data-number="7.2.3">
<h3 data-number="7.2.3" class="anchored" data-anchor-id="comparación-de-modelos"><span class="header-section-number">7.2.3</span> Comparación de modelos</h3>
</section>
<section id="medición-de-un-modelo-error-de-predicción" class="level3" data-number="7.2.4">
<h3 data-number="7.2.4" class="anchored" data-anchor-id="medición-de-un-modelo-error-de-predicción"><span class="header-section-number">7.2.4</span> Medición de un Modelo – Error de Predicción</h3>
<section id="predicción-vs.-observación" class="level4" data-number="7.2.4.1">
<h4 data-number="7.2.4.1" class="anchored" data-anchor-id="predicción-vs.-observación"><span class="header-section-number">7.2.4.1</span> Predicción vs.&nbsp;Observación</h4>
<p>Una forma de medir qué tan bien está funcionando un modelo es comparar las predicciones que el modelo hace para la variable de respuesta <span class="math inline">\(\hat y_i\)</span> con los valores de respuesta observados en los datos <span class="math inline">\(y_i\)</span>. Para simplificar las cosas, nos gustaría convertir estas <span class="math inline">\(n\)</span> predicciones y <span class="math inline">\(n\)</span> observaciones en un solo número.</p>
<p>Esto se puede realizar simplemente a través de: <strong>Suma de Errores Cuadrados</strong> (SSE) o el <strong>Error Cuadrático Medio</strong> (MSE).</p>
<span class="math display">\[\begin{align*}
SSE &amp; = \sum_{i = 1}^n (y_i - \hat y_i)^2 \\
MSE &amp; = \frac{1}{n} SSE = \frac{1}{n} \sum_{i = 1}^n (y_i - \hat y_i)^2
\end{align*}\]</span>
<p>También a través del <span class="math inline">\(r^2\)</span>:</p>
<span class="math display">\[\begin{align*}
SSE &amp;= \sum_{i = 1}^n (y_i - \hat y_i)^2 \\
SST &amp;= \sum_{i = 1}^n (y_i - \overline{y})^2 \\
r^2 &amp;= 1 - \frac{SSE}{SST}
\end{align*}\]</span>
<p>Estamos trabajando con modelos bayesianos, por lo que el <span class="math inline">\(SSE\)</span>, <span class="math inline">\(MSE\)</span> y <span class="math inline">\(r^2\)</span> tienen distribuciones posteriores, ya que dependen de (la distribución posterior de) <span class="math inline">\(\theta\)</span>.</p>
<p>Juntando todo eso para resaltar la dependencia de <span class="math inline">\(\theta\)</span>, obtenemos</p>
<p><span class="math display">\[MSE = \frac{1}{n} \sum_{i = 1}^n (y_i - E(y_i \mid \theta))^2\]</span></p>
</section>
<section id="densidad-predictiva-logarítmica" class="level4" data-number="7.2.4.2">
<h4 data-number="7.2.4.2" class="anchored" data-anchor-id="densidad-predictiva-logarítmica"><span class="header-section-number">7.2.4.2</span> Densidad predictiva (logarítmica)</h4>
<p>Otra opción es calcular la <strong>densidad predictiva logarítmica</strong> (lpd):</p>
<p><span class="math display">\[\mathrm{lpd}(\theta; y) = \log p(y \mid \theta)\]</span></p>
<p>Una vez más, <span class="math inline">\(y\)</span> está fijado, por lo que esto es una función de <span class="math inline">\(\theta\)</span>. De hecho, es simplemente la función de verosimilitud logarítmica. Para un valor dado de <span class="math inline">\(\theta\)</span>, la lpd mide (en una escala logarítmica) la probabilidad de observar los datos. Un valor más grande indica un mejor ajuste. Nuevamente, debido a que la lpd es una función de <span class="math inline">\(\theta\)</span>, también tiene una distribución posterior.</p>
<p>Asumiendo que los valores de <span class="math inline">\(y\)</span> son independientes dados los parámetros (y los valores predictores <span class="math inline">\(x\)</span>), esto se puede escribir como</p>
<p><span class="math display">\[
\mathrm{lpd}(\theta; y)
= \log p(y \mid \theta)
= \log \prod_{i = 1}^n p(y_i \mid \theta)
= \sum_{i = 1}^n \log p(y_i \mid \theta)
\]</span></p>
<p>En este caso, podemos calcular la densidad posterior logarítmica punto por punto y sumar. En la práctica, esto se hace a menudo incluso cuando no se cumple la independencia. Por lo tanto, técnicamente estamos trabajando con la <strong>densidad posterior logarítmica punto por punto</strong>:</p>
<p><span class="math display">\[
\mathrm{lppd}(\theta; y)
= \sum_{i = 1}^n \log p(y_i \mid \theta)
\]</span></p>
<p>Al igual que el <span class="math inline">\(SSE\)</span>, el <span class="math inline">\(MSE\)</span> y el <span class="math inline">\(r^2\)</span>, esto asigna una puntuación a cada <span class="math inline">\(i\)</span> y luego suma esas puntuaciones.</p>
<p>Para modelos lineales con ruido normal y priors uniformes, la lpd es proporcional al <span class="math inline">\(MSE\)</span> (y al <span class="math inline">\(SSE\)</span>).</p>
</section>
<section id="predictores" class="level4" data-number="7.2.4.3">
<h4 data-number="7.2.4.3" class="anchored" data-anchor-id="predictores"><span class="header-section-number">7.2.4.3</span> Predictores</h4>
<p>En la notación anterior, hemos estado ocultando el papel de los predictores <span class="math inline">\(x\)</span> (y continuaremos haciéndolo a continuación). Un modelo con predictores hace diferentes predicciones dependiendo de los valores de los predictores:</p>
<p><span class="math display">\[
\mathrm{lpd}(\theta; y, x)
= \log p(y \mid \theta, x)
\]</span></p>
</section>
<section id="números-a-partir-de-distribuciones" class="level4" data-number="7.2.4.4">
<h4 data-number="7.2.4.4" class="anchored" data-anchor-id="números-a-partir-de-distribuciones"><span class="header-section-number">7.2.4.4</span> Números a partir de distribuciones</h4>
<p>Podemos convertir una medida <span class="math inline">\(\mathrm{lpd}(\theta; y)\)</span>, que depende de <span class="math inline">\(\theta\)</span>, en un solo número de varias maneras. Ilustraremos esto a continuación:</p>
<ol type="1">
<li>Podríamos reemplazar <span class="math inline">\(\theta\)</span> con un número particular <span class="math inline">\(\hat \theta\)</span>. (<span class="math inline">\(\hat \theta\)</span> podría ser la media, la mediana o la moda de la distribución posterior, o la moda de la función de verosimilitud, por ejemplo). Si hacemos esto, obtenemos el número</li>
</ol>
<p><span class="math display">\[
\mathrm{lpd}(\hat \theta; y)
= \log p(y \mid \hat\theta)
= \sum_{i = 1}^n \log p(y_i \mid \hat \theta)
\]</span> Esto a veces se llama una estimación “plug-in” ya que estamos insertando un solo número para <span class="math inline">\(\theta\)</span>.</p>
<ol start="2" type="1">
<li>En lugar de resumir <span class="math inline">\(\theta\)</span> con un solo número, podríamos resumir <span class="math inline">\(p(y_i \mid \theta)\)</span> con un solo número promediando sobre los valores de la muestra posterior <span class="math inline">\(p(y_i \mid \theta^s)\)</span>. (<span class="math inline">\(\theta^s\)</span> denota el valor de <span class="math inline">\(\theta\)</span> en la fila <span class="math inline">\(s\)</span> de nuestras <span class="math inline">\(S\)</span> muestras posteriores). Si sumamos sobre <span class="math inline">\(i\)</span>, obtenemos la <strong>densidad de verosimilitud posterior puntual logarítmica</strong> (lppd):</li>
</ol>
<span class="math display">\[\begin{align}
\mathrm{lppd}  
&amp;\approx
\sum_{i = 1}^n \log \left( \frac{1}{S} \sum_{s = 1}^S  p(y_i \mid \theta^s)\right)
\end{align}\]</span>
<p>Esto es una aproximación porque nuestras muestras posteriores son solo una aproximación a la verdadera distribución posterior. Pero si el tamaño efectivo de la muestra de la posterior es grande, esta aproximación debería ser muy buena.</p>
<p>Desafortunadamente, ambas medidas (<span class="math inline">\(MSE\)</span> y densidad predictiva logarítmica) tienen un problema. Miden qué tan bien el modelo se ajusta a los datos utilizados para ajustar el modelo, pero estamos más interesados en qué tan bien el modelo podría ajustarse a nuevos datos (generados por el mismo proceso aleatorio que generó los datos actuales). Esto lleva a <strong>sobreajuste</strong> y <strong>prefiere modelos más grandes y complejos</strong>, ya que la flexibilidad adicional de estos modelos hace que sea más fácil para ellos “ajustar los datos”.</p>
<!-- ### Out-of-sample prediction error -->
<!-- More interesting would be to measure how well the models would fit **new data**. -->
<!-- This is referred to as **out-of-sample prediction**, in contrast to  -->
<!-- **in-sample prediction**.   -->
<!-- So let's consider how well our model predicts new data $\tilde y$ rather than -->
<!-- the observed data $y$:  -->
<!-- $$ -->
<!-- \mathrm{lpd}(\theta; \tilde y)  -->
<!-- = \log p(\tilde y \mid \theta) -->
<!-- = \log \prod_{i = 1}^n p(\tilde y_i \mid \theta) -->
<!-- = \sum_{i = 1}^n \log p(\tilde y_i \mid \theta) -->
<!-- $$ -->
<!-- which we can convert into a single number by plugging by posterior averaging: -->
<!-- And since $\tilde y$ is not fixed (like $y$ was), we take an additional -->
<!-- step and compute the expected value (average) of this quantity over the  -->
<!-- distribution of $\tilde y_i$ to get the **expected log (pointwise) predictive density** for a new response $\tilde y_i$:[^20-2] -->
<!-- [^20-2]: Technically, we should be computing the average using an integral -->
<!-- instead of averaging over our posterior samples. But since this is a quantity -->
<!-- we can't compute anyway, I've expressed this in terms of an average over -->
<!-- our posterior samples. -->
<!-- $$ -->
<!-- \mathrm{elppd}  -->
<!-- = -->
<!-- \mathrm{E}\left(\sum_{i = 1}^n \log p_{\mathrm{post}}(\tilde y_i)\right) -->
<!-- \approx -->
<!-- \sum_{i = 1}^n \mathrm{E}\left(\log  -->
<!-- \frac{1}{S} \sum_{s = 1}^S p(\tilde y_i \mid \theta^s))\right) -->
<!-- $$ -->
<!-- This expected value is taken over the true distribution of $\tilde y_i$ (which is a -->
<!-- problem, stay tuned.) -->
<!-- ### Approximating out-of-sample prediction error -->
<!-- What we would ideally want (elppd), we cannot compute -->
<!-- since it requires us to know the distribution of out-of-sample data  -->
<!-- ($\tilde y_i$). -->
<!-- This leads us to the following impossible set of goals for our ideal  -->
<!-- measure of model (predictive) performance (borrowed from [@Gelman:2014]): -->
<!-- * an **unbaised** and **accurate** measure  -->
<!-- * of **out-of-sample prediction** error (elppd) -->
<!-- * that will be valid over a **general** class of models, -->
<!-- * and that **requires minimal computation** beyond that need to fit the model  -->
<!-- in the first place. -->
<!-- Here are three approaches to solving this problem -->
<!-- 1. Use within-sample predictive accuracy. -->
<!--     But this isn't ideal since it overestimates performace of the model -->
<!--     (and more so for more complicated models). -->
<!-- 2. Adjust within-sample predictive accuracy. -->
<!--     Within-sample predictive accuracy will over-estimate out-of-sample predictive  -->
<!--     accuracy. If we knew (or could estimate) by how much, we could adjust -->
<!--     by that amount to eliminate (or reduce) the bias. Quantities like -->
<!--     AIC (Aikeke's information criterion),  -->
<!--     DIC (deviance information criterion),  -->
<!--     and WAIC (widely applicable information criterion) -->
<!--     take the approach of substracting something from lppd that  -->
<!--     depends on the complexity of the model. -->
<!-- 3. Use cross-validation -->
<!--     The main idea here is to use some of the data to fit the model and the rest  -->
<!--     of the data to evaluate prediction error. This is a poor person's version of  -->
<!--     "out-of-sample".  We will focus on **leave one out** (LOO) cross validation  -->
<!--     where we fit the model $n$ times, each time leaving out one row of the data -->
<!--     and using the resulting model to predict the removed row. -->
<!--     If we really needed to recompute the model $n$ times,  -->
<!--     this would be too computationally expensive for large data sets and complex -->
<!--     models.  But there are (more) efficient -->
<!--     approximations to LOO-cv that make it doable. They are based on the idea -->
<!--     that the posterior distribution using $y(-i)$ (all but row $i$ of the data) -->
<!--     should usually be similar to the posterior distribution using $y$ (all of the data). -->
<!--     So we can recycle the work done to compute our original posterior. -->
<!--     The result is only an approximation, and it doesn't always work well,  -->
<!--     so sometimes we have to recreate the posterior from scratch, at least for  -->
<!--     some of the rows. -->
<!-- The formulas for **estimated out-of-sample predictive density** -->
<!-- \begin{align*} -->
<!-- \widehat{\mathrm{elppd}}_{\mathrm{AIC}} -->
<!--   &= \mathrm{lpd}(\hat\theta_{\mathrm{mle}}, y) - p_{\mathrm{AIC}} \\ -->
<!-- \widehat{\mathrm{elppd}}_{\mathrm{DIC}}  -->
<!--   &= \mathrm{lpd}(\hat\theta_{\mathrm{Bayes}}, y) - p_{\mathrm{DIC}} \\ -->
<!-- \widehat{\mathrm{elppd}}_{\mathrm{WAIC}}  -->
<!--   &= \mathrm{lppd} - p_{\mathrm{WAIC}} \\ -->
<!-- \widehat{\mathrm{elppd}}_{\mathrm{LOO}}  -->
<!--   &= \sum_{i=1}^n \log p_{\mathrm{post}(-i)}(y_i)  -->
<!--   \approx \sum_{i=1}^n \log \left( \frac{1}{S} \sum_{s = 1}^S p(y_i \mid \theta^{is})\right) -->
<!-- \end{align*} -->
<!-- and the associated **effictive number of parameters**: -->
<!-- \begin{align*} -->
<!-- p_{\mathrm{AIC}}  &= \mbox{number of parameters in the model}\\ -->
<!-- p_{\mathrm{DIC}}  &= 2 \mathrm{var}_{\mathrm{post}}(\log p(y \mid \theta)) \\ -->
<!-- p_{\mathrm{WAIC}} &= 2 \mathrm{var}_{\mathrm{post}}(\sum_{i = 1}^n \log p(y_i \mid \theta)) \\ -->
<!-- p_{\mathrm{LOO}}  &= \hat{\mathrm{llpd}} - \hat{\mathrm{llpd}}_{\mathrm{LOO}} \\ -->
<!-- \end{align*} -->
<!-- Notes -->
<!-- 1. $\theta^{is}$ is the value of $\theta$ in row $s$ of the posterior distribution -->
<!-- *when row $i$ has been removed from the data*.  What makes LOO practical is  -->
<!-- that this can be approximated without refitting the model $n$ times. -->
<!-- 1. AIC and DIC differ from WAIC and LOO in that they use a point estimate -->
<!-- for $\theta$ (the maximum likelihood estimate for AIC and the  -->
<!-- mode of the posterior distribution for DIC) rather than using the  -->
<!-- full posterior distribution. -->
<!-- 1. AIC penalizes a model 1 for each parameter.  This is correct for linear -->
<!-- models with normal noise and uniform priors, but is not correct in general. -->
<!-- You can think of DIC and WAIC as estimating the effective number of  -->
<!-- parameters by looking at how much variation there is in $\log(p(y_i \mid \theta))$. -->
<!-- The more this quantity changes with changes in $\theta$, the more flexible -->
<!-- the model is (and the more it should be penalized). -->
<!-- 1. LOO doesn't work by adusting for an estimated number of parameters; -->
<!-- it attempts to estimate elppd directly. -->
<!-- But we can reverse engineer things to get an estimated number of parameters -->
<!-- by taking the difference between -->
<!-- the (estimated) within-sample and out-of-sample predictive density. -->
<!-- 1. LOO and WAIC are assymptotically equivalent (that is they give more  -->
<!-- and more similar values as the sample size increases), but LOO typically -->
<!-- performs a bit better on small data sets, so the authors of the loo package  -->
<!-- recommend LOO over WAIC as the go-to measure for comparing models. -->
<!-- 1. Historically, information criteria have been expressed on the "devaiance scale". -->
<!-- To convert from log predictive density scale to deviance scale, we multiply by -2.  -->
<!-- On the  deviance scale, smaller is better.  -->
<!-- On the log predictive density scale, larger is better  -->
<!-- (but the values are usually negative.) The `waic()` and `loo()` functions  -->
<!-- compute both values. -->
<!-- 1. The output from `loo()` and `waic()` labels things elpd rather than elppd. -->
<!-- ## Using loo -->
<!-- The loo package provides functions for computing WAIC and LOO estimates of  -->
<!-- epld (and their information criterion counterparts). -->
<!-- While the definitions are a bit involved,  -->
<!-- using WAIC or LOO to compare models is relatively easy. -->
<!-- WAIC can be faster, but LOO performs better (according to the authors of  -->
<!-- the loo package). -->
<!-- ```{r} -->
<!-- library(loo) -->
<!-- waic(fert4_brm) -->
<!-- loo(fert4_brm) -->
<!-- ``` -->
<!-- Sometimes the LOO-PSIS (Pareto-smoothed importance sampling) approximation  -->
<!-- method doesn't work well and `loo()` recommends refitting some of the models  -->
<!-- from scratch. This is based on the shape parameter (k) of the Pareto distribution -->
<!-- used to smooth the tails of the posterior. -->
<!-- Let's allow `loo()` to run from scratch the models it thinks need it.  -->
<!-- (This is still much faster than refitting a model for each row of the  -->
<!-- data since we only start from scratch a small number of times. And we don't -->
<!-- need to recompile the model, since that doesn't change; we just need to  -->
<!-- generate posterior samples using a different data set.) -->
<!-- If there are quite a number of these, `loo()` will suggest k-fold cross-validation -->
<!-- instead of leave-one-out cross-validation. These leaves out multiple rows of -->
<!-- data from each refit.  Since there are fewer models this way, it can exchange speed -->
<!-- for accuracy. -->
<!-- ```{r ch20-loo-reloo, cache = TRUE} -->
<!-- fert4_loo <- loo(fert4_brm, reloo = TRUE) # refit as necessary -->
<!-- ``` -->
<!-- In this case, things didn't change that much when refitting the six "bad" models. -->
<!-- ```{r ch20-loo4-reprise} -->
<!-- fert4_loo -->
<!-- plot(fert4_loo) -->
<!-- fert4a_loo <- loo(fert4_brm) -->
<!-- plot(fert4a_loo) -->
<!-- ``` -->
<!-- If we have multiple models, we can use `loo::compare()` to compare them based on -->
<!-- WAIC or LOO. Before doing that, let's add one more model to our list. -->
<!-- ```{r ch20-fert5, results = "hide", cache = TRUE} -->
<!-- fert5_brm <- -->
<!--   brm(Yield ~ Till + Fert + (1 | Field), data = SplitPlotAgri) -->
<!-- ``` -->
<!-- ```{r ch20-waic-all, results = "hide", cache = TRUE} -->
<!-- library(loo) -->
<!-- compare( -->
<!--   waic(fert1_brm),  -->
<!--   waic(fert2_brm), -->
<!--   waic(fert4_brm), -->
<!--   waic(fert5_brm) -->
<!-- ) -->
<!-- ``` -->
<!-- ```{r ch20-loo2, cache = TRUE, results = "hide", cache = TRUE} -->
<!-- fert1_loo <- loo(fert1_brm)  -->
<!-- fert2_loo <- loo(fert2_brm)  -->
<!-- fert5_loo <- loo(fert5_brm)  -->
<!-- ``` -->
<!-- Now we can compare our four models using LOO: -->
<!-- ```{r ch20-loo3, cache = TRUE, resuls = "hide"} -->
<!-- compare(fert1_loo, fert2_loo, fert4_loo, fert5_loo) -->
<!-- ``` -->
<!-- Important things to remember: -->
<!-- 1. Estimated elpd and information criteria are not  -->
<!-- meaningful on their own, they are only useful for **comparisons**. -->
<!-- 2. Comparisons can only be made among models that are fit using the **same data** -->
<!-- since the computed values depend on both the model and the data. -->
<!-- 3. All of these methods are approximate. `loo()` and `waic()` provide  -->
<!-- standard errors as well as estimates.  -->
<!-- Use those to help determine whether differences between models -->
<!-- are meaningful or not. -->
<!-- 4. `p_loo` (effective number of parameters) is also an interesting measure. -->
<!-- If this estimate does not seem to correspond to roughly the number of free  -->
<!-- parameters in your model, that is usually a sign that something is wrong.  (Perhaps -->
<!-- the model is mis-specified.) Keep in mind that multi-level models or models  -->
<!-- with strong priors place some restrictions on the parameters. This can lead -->
<!-- to an effective number of parameters that is smaller than the actual number  -->
<!-- of parameters. -->
<!-- 5. This is only one aspect of how a model is performing. There may be good  -->
<!-- reasons to prefer a model with lower (estimated) log predictive density. -->
<!-- Posterior predictive checks, theory, interpretability, etc. can all be part -->
<!-- of deciding which models are better. But these methods can help us avoid  -->
<!-- selecting models that only look good because they are overfitting. -->
<!--     Note: Sometimes the best solution is to create a new model that combines -->
<!--     elements from models tried along the way. -->
<!-- 6. Beware of "model hacking." If you try enough models, you might stumble across -->
<!-- something. But it might not be meaningful. Choose models with some thought, don't -->
<!-- just keep trying models in hopes that one of them will produce something interesting. -->


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./estimacion_modelos2.html" class="pagination-link" aria-label="Estimación de Modelos Bayesianos (Parte 2)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Estimación de Modelos Bayesianos (Parte 2)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>